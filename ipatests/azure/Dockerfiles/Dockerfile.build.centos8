FROM quay.io/abbra/centos:CentOS-8.Stream-x86_64
MAINTAINER [FreeIPA Developers freeipa-devel@lists.fedorahosted.org]
ENV container=docker LANG=en_US.utf8 LANGUAGE=en_US.utf8 LC_ALL=en_US.utf8

ADD dist /root
RUN echo $'[centos-8-stream-dev] \n\
name = CentOS Developmental 8 \n\
baseurl = http://mirror.centos.org/centos/8-stream/Devel/x86_64/os/ \n\
enabled = 1 \n\
gpgcheck = 0' > /etc/yum.repos.d/centos-8-stream.repo
RUN echo 'deltarpm = false' >> /etc/dnf/dnf.conf \
    && dnf update -y dnf \
    && dnf install -y dnf-plugins-core sudo wget systemd firewalld nss-tools iptables \
    && sed -i 's/%_install_langs \(.*\)/\0:fr/g' /etc/rpm/macros.image-language-conf \
    && dnf install -y glibc-langpack-fr glibc-langpack-en \
    && dnf -y module enable idm:DL1 \
    && dnf install -y /root/rpms/*.rpm \
    && dnf install -y openssh-server \
    && dnf clean all && rm -rf /root/rpms /root/srpms \
    && sed -i 's/.*PermitRootLogin .*/#&/g' /etc/ssh/sshd_config \
    && echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config \
    && systemctl enable sshd \
    && for i in /usr/lib/systemd/system/*-domainname.service; \
    do sed -i 's#^ExecStart=/#ExecStart=-/#' $i ; done

STOPSIGNAL RTMIN+3
VOLUME ["/freeipa", "/run", "/tmp"]
ENTRYPOINT [ "/usr/sbin/init" ]
